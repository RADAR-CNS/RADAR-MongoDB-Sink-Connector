//---------------------------------------------------------------------------//
// Preparing WAR                                                             //
//---------------------------------------------------------------------------//
ext.dockerImage = "${projectDir}/src/endToEndTest/image"

task copyJarForIntegration(type: Copy, dependsOn: jar) {
    from "${jar.archivePath}"
    into "${dockerImage}"
    doLast{
        file("${dockerImage}/${jar.archiveName}").renameTo("${dockerImage}/radar-mongo-connector.jar")
    }
}

task removeJar(type: Delete) {
    delete "${dockerImage}/radar-mongo-connector.jar"
}

//---------------------------------------------------------------------------//
// Docker stack                                                              //
//---------------------------------------------------------------------------//
ext.dockerCompose = hasProperty('dockerComposePath') ? property('dockerComposePath') : 'docker-compose'
ext.sudoLinux = System.properties['os.name'].toLowerCase().contains('linux') ? ['sudo'] : []

ext.containerName = 'radarcns/radar-mongodb-connector:dev'
ext.radarStackPath = 'src/endToEndTest/radarDocker/dcompose-stack/radar-cp-hadoop-stack'
ext.radarStackLock = "${radarStackPath}/.RUNNING_INSTANCE_LOCK"
ext.radarDockerCompose = 'docker-compose.yml'
ext.radarDockerComposeOriginal = ".${radarDockerCompose}.orig"

task buildDocker(type: Exec, dependsOn: copyJarForIntegration) {
    workingDir "${dockerImage}"
    commandLine sudoLinux + ['docker', 'image', 'build', '-t', containerName, '.']
}

// Sets configuration files for running the entire platform
task setRadarEnvironmentForDocker(dependsOn: buildDocker) {
    doLast {
        def envTemplatePath = "${radarStackPath}/etc/env.template"
        def smtpTemplatePath = "${radarStackPath}/etc/smtp.env.template"
        def streamTemplatePath = "${radarStackPath}/etc/radar.yml.template"

        def volumes = file("${radarStackPath}/volumes")
        volumes.mkdir()

        def fileEnv = file(envTemplatePath + 'tmp')
        fileEnv << file(envTemplatePath).text
        fileEnv.text = fileEnv.text.replace('/usr/local/var/lib/docker', volumes.getAbsolutePath())
        fileEnv.text = fileEnv.text.replace('HOTSTORAGE_USERNAME=<mongodb-user>', 'HOTSTORAGE_USERNAME=restapi')
        fileEnv.text = fileEnv.text.replace('HOTSTORAGE_PASSWORD=XXXXXXXX', 'HOTSTORAGE_PASSWORD=radarcns')
        fileEnv.text = fileEnv.text.replace('HOTSTORAGE_NAME=<mongodb-database>', 'HOTSTORAGE_NAME=hotstorage')
        fileEnv.renameTo("${radarStackPath}/.env")

        def fileSmtp = file(smtpTemplatePath + 'tmp')
        fileSmtp << file(smtpTemplatePath).text
        fileSmtp.renameTo("${radarStackPath}/etc/smtp.env")

        def fileStream = file(streamTemplatePath + 'tmp')
        fileStream << file(streamTemplatePath).text
        fileStream.renameTo("${radarStackPath}/etc/radar.yml")

        def installScript = file("${radarStackPath}/install-radar-stack.sh")
        installScript.text = installScript.text.replace(' docker-compose ', " ${dockerCompose} ")

        def dockerComposeYml = file("${radarStackPath}/${radarDockerCompose}")
        file("${radarStackPath}/${radarDockerComposeOriginal}") << dockerComposeYml.text
        def dockerComposeTmp = file("${radarStackPath}/.${radarDockerCompose}.tmp")
        dockerComposeTmp << dockerComposeYml.text.replaceAll('radarcns/radar-mongodb-connector-auto:.*', containerName)
        dockerComposeTmp.renameTo("${radarStackPath}/${radarDockerCompose}")
    }
}

task validateCompose(type: Exec, dependsOn: setRadarEnvironmentForDocker) {
    workingDir radarStackPath
    standardInput = System.in
    commandLine sudoLinux + [dockerCompose, 'config', '-q']
}

task installRadarStack(type: Exec, dependsOn: validateCompose) {
    doFirst{
        def lockFile = new File(radarStackLock)
        if (lockFile.exists()) {
            throw new GradleException("A previous instance of RADAR Platform is still running. Please stop it first and then try again.")
        } else {
            lockFile.createNewFile()
        }
    }

    workingDir radarStackPath
    standardInput = System.in
    commandLine sudoLinux + ['./install-radar-stack.sh', 'radar-mongodb-connector']
}

task listDockerProcesses(type: Exec) {
    workingDir radarStackPath
    standardInput = System.in
    commandLine sudoLinux + [dockerCompose, 'ps']
}
listDockerProcesses.mustRunAfter 'installRadarStack'

ext.stoppingStack = false
task stopRadarStack(type: Exec) {
    onlyIf{
        new File(radarStackLock).exists() && !stoppingStack
    }
    doFirst{
        stoppingStack = true
    }

    standardInput = System.in
    workingDir radarStackPath
    commandLine sudoLinux + [dockerCompose, 'down', '-v']

    doLast{
        stoppingStack = false
    }
}

task cleanRadarStack(type: Exec, dependsOn: stopRadarStack) {
    onlyIf{
        !stoppingStack
    }
    commandLine sudoLinux + ['rm', '-rf', "${radarStackPath}/volumes", radarStackLock]
    doLast{
        file("${radarStackPath}/${radarDockerComposeOriginal}").renameTo("${radarStackPath}/${radarDockerCompose}")
    }
}
stopRadarStack.finalizedBy cleanRadarStack
cleanRadarStack.finalizedBy removeJar